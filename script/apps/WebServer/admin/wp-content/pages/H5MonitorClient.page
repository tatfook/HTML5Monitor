<?npl
--[[
Title: H5MonitorClient.page
Author: leio
Date: 2016/7/21
Desc: 
]]

wp_enqueue_script("ace",						"/wp-includes/js/ace/ace.js"); 
wp_enqueue_script("angular",					"/wp-includes/js/angular/angular.min.js");
wp_enqueue_script("ngStorage",					"/wp-includes/js/angular/ngStorage.js");
wp_enqueue_script("ngSanitize",					"/wp-includes/js/angular/angular-sanitize.min.js");

wp_enqueue_script("H5Monitor_App",					"/wp-content/pages/h5monitor/app.js");
wp_enqueue_script("h5MonitorClientController",			"/wp-content/pages/h5monitor/controllers/h5MonitorClientController.js");

NPL.load("(gl)Mod/HTML5Monitor/H5MonitorClient.lua");
local H5MonitorClient = commonlib.gettable("Mod.HTML5Monitor.H5MonitorClient");

NPL.load("(gl)script/ide/System/Encoding/base64.lua");
local Encoding = commonlib.gettable("System.Encoding");

if(is_ajax()) then
	add_action('wp_ajax_monitor_start', function()
		local ip = request:get("ip");		
		local port = request:get("port");		
		H5MonitorClient.Start(tostring(ip),tostring(port));
		wp_send_json({}, true);
    end)
	add_action('wp_ajax_monitor_stop', function()
		H5MonitorClient.Stop();
    end)
	
	add_action('wp_ajax_monitor_send', function()
		local txt = request:get("txt");		
		local msg = {
			txt = txt,
		}
		H5MonitorClient.Send(msg);
    end)
	add_action('wp_ajax_monitor_poll_msg', function()
		local output = {};
		output.msgs = H5MonitorClient.GetHandleMsg();
		wp_send_json(output, true);
    end)
	add_action('wp_ajax_monitor_take_screen_shot', function()
		local width = request:get("width");		
		local height = request:get("height");
			
		local imageData, imageSize = H5MonitorClient.TakeScreenShot(width,height);
		local output = { 
				imageData = Encoding.base64(imageData),
				imageSize = imageSize,
		};
		wp_send_json(output, true);
    end)
	return;
end

?>
<h1>Monitor Client</h1>
<div ng-app="H5MonitorClient_App" >
	<monitor-client></monitor-client>
</div>

